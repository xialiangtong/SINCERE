<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DataTransformer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sincere</a> &gt; <a href="index.source.html" class="el_package">default</a> &gt; <span class="el_source">DataTransformer.java</span></div><h1>DataTransformer.java</h1><pre class="source lang-java linenums">import java.math.BigDecimal;
import java.math.RoundingMode;
import java.time.Instant;
import java.time.LocalDate;
import java.time.ZoneOffset;
import java.util.*;
import java.util.stream.Collectors;

/**
 * Data Transformation Pipeline
 * 
 * Ingests orders from CSV or JSON, normalizes to canonical model,
 * aggregates metrics, and outputs results.
 */
<span class="nc" id="L15">public class DataTransformer {</span>

    // ==================== CANONICAL MODEL ====================

    /**
     * Represents a line item in an order.
     */
    public static class Item {
        private final String sku;
        private final int quantity;
        private final BigDecimal unitPrice;

<span class="nc" id="L27">        public Item(String sku, int quantity, BigDecimal unitPrice) {</span>
<span class="nc" id="L28">            this.sku = sku.trim();</span>
<span class="nc" id="L29">            this.quantity = quantity;</span>
<span class="nc" id="L30">            this.unitPrice = unitPrice;</span>
<span class="nc" id="L31">        }</span>

<span class="nc" id="L33">        public String getSku() { return sku; }</span>
<span class="nc" id="L34">        public int getQuantity() { return quantity; }</span>
<span class="nc" id="L35">        public BigDecimal getUnitPrice() { return unitPrice; }</span>

        public BigDecimal getLineTotal() {
<span class="nc" id="L38">            return unitPrice.multiply(BigDecimal.valueOf(quantity));</span>
        }

        @Override
        public String toString() {
<span class="nc" id="L43">            return &quot;Item{sku='&quot; + sku + &quot;', qty=&quot; + quantity + &quot;, price=&quot; + unitPrice + &quot;}&quot;;</span>
        }
    }

    /**
     * Represents order charges.
     */
    public static class Charges {
        private final BigDecimal subtotal;
        private final BigDecimal discount;
        private final BigDecimal tax;
        private final BigDecimal shipping;

<span class="nc" id="L56">        public Charges(BigDecimal subtotal, BigDecimal discount, BigDecimal tax, BigDecimal shipping) {</span>
<span class="nc" id="L57">            this.subtotal = subtotal;</span>
<span class="nc" id="L58">            this.discount = discount;</span>
<span class="nc" id="L59">            this.tax = tax;</span>
<span class="nc" id="L60">            this.shipping = shipping;</span>
<span class="nc" id="L61">        }</span>

<span class="nc" id="L63">        public BigDecimal getSubtotal() { return subtotal; }</span>
<span class="nc" id="L64">        public BigDecimal getDiscount() { return discount; }</span>
<span class="nc" id="L65">        public BigDecimal getTax() { return tax; }</span>
<span class="nc" id="L66">        public BigDecimal getShipping() { return shipping; }</span>

        public BigDecimal getTotal() {
<span class="nc" id="L69">            return subtotal.subtract(discount).add(tax).add(shipping);</span>
        }
    }

    /**
     * Canonical order representation.
     */
    public static class Order {
        private final String orderId;
        private final Instant createdAt;
        private final String customerId;
        private final String currency;
        private final List&lt;Item&gt; items;
        private final Charges charges;

        public Order(String orderId, Instant createdAt, String customerId, 
<span class="nc" id="L85">                     String currency, List&lt;Item&gt; items, Charges charges) {</span>
<span class="nc" id="L86">            this.orderId = orderId.trim();</span>
<span class="nc" id="L87">            this.createdAt = createdAt;</span>
<span class="nc" id="L88">            this.customerId = customerId.trim();</span>
<span class="nc" id="L89">            this.currency = currency.trim().toUpperCase();</span>
<span class="nc" id="L90">            this.items = Collections.unmodifiableList(new ArrayList&lt;&gt;(items));</span>
<span class="nc" id="L91">            this.charges = charges;</span>
<span class="nc" id="L92">        }</span>

<span class="nc" id="L94">        public String getOrderId() { return orderId; }</span>
<span class="nc" id="L95">        public Instant getCreatedAt() { return createdAt; }</span>
<span class="nc" id="L96">        public String getCustomerId() { return customerId; }</span>
<span class="nc" id="L97">        public String getCurrency() { return currency; }</span>
<span class="nc" id="L98">        public List&lt;Item&gt; getItems() { return items; }</span>
<span class="nc" id="L99">        public Charges getCharges() { return charges; }</span>

        public BigDecimal getTotal() {
<span class="nc" id="L102">            return charges.getTotal();</span>
        }

        public LocalDate getOrderDate() {
<span class="nc" id="L106">            return createdAt.atZone(ZoneOffset.UTC).toLocalDate();</span>
        }

        public BigDecimal getItemsTotal() {
<span class="nc" id="L110">            return items.stream()</span>
<span class="nc" id="L111">                    .map(Item::getLineTotal)</span>
<span class="nc" id="L112">                    .reduce(BigDecimal.ZERO, BigDecimal::add);</span>
        }
    }

    // ==================== ERROR HANDLING ====================

    /**
     * Represents a parsing/validation error.
     */
    public static class ParseError {
        private final String source;
        private final int row;
        private final String message;

<span class="nc" id="L126">        public ParseError(String source, int row, String message) {</span>
<span class="nc" id="L127">            this.source = source;</span>
<span class="nc" id="L128">            this.row = row;</span>
<span class="nc" id="L129">            this.message = message;</span>
<span class="nc" id="L130">        }</span>

<span class="nc" id="L132">        public String getSource() { return source; }</span>
<span class="nc" id="L133">        public int getRow() { return row; }</span>
<span class="nc" id="L134">        public String getMessage() { return message; }</span>

        @Override
        public String toString() {
<span class="nc" id="L138">            return &quot;{\&quot;source\&quot;:\&quot;&quot; + source + &quot;\&quot;,\&quot;row\&quot;:&quot; + row + </span>
<span class="nc" id="L139">                   &quot;,\&quot;message\&quot;:\&quot;&quot; + message.replace(&quot;\&quot;&quot;, &quot;\\\&quot;&quot;) + &quot;\&quot;}&quot;;</span>
        }
    }

    /**
     * Result of parsing containing valid orders and errors.
     */
    public static class ParseResult {
        private final List&lt;Order&gt; orders;
        private final List&lt;ParseError&gt; errors;

<span class="nc" id="L150">        public ParseResult(List&lt;Order&gt; orders, List&lt;ParseError&gt; errors) {</span>
<span class="nc" id="L151">            this.orders = new ArrayList&lt;&gt;(orders);</span>
<span class="nc" id="L152">            this.errors = new ArrayList&lt;&gt;(errors);</span>
<span class="nc" id="L153">        }</span>

<span class="nc" id="L155">        public List&lt;Order&gt; getOrders() { return orders; }</span>
<span class="nc" id="L156">        public List&lt;ParseError&gt; getErrors() { return errors; }</span>

<span class="nc" id="L158">        public void addOrder(Order order) { orders.add(order); }</span>
<span class="nc" id="L159">        public void addError(ParseError error) { errors.add(error); }</span>

        public void merge(ParseResult other) {
<span class="nc" id="L162">            orders.addAll(other.orders);</span>
<span class="nc" id="L163">            errors.addAll(other.errors);</span>
<span class="nc" id="L164">        }</span>
    }

    // ==================== PARSERS ====================

    /**
     * Parser interface for different input formats.
     */
    public interface OrderParser {
        ParseResult parse(String input);
    }

    /**
     * CSV Order Parser.
     */
<span class="nc" id="L179">    public static class CsvOrderParser implements OrderParser {</span>
<span class="nc" id="L180">        private static final BigDecimal TOLERANCE = new BigDecimal(&quot;0.01&quot;);</span>

        @Override
        public ParseResult parse(String input) {
<span class="nc" id="L184">            ParseResult result = new ParseResult(new ArrayList&lt;&gt;(), new ArrayList&lt;&gt;());</span>
<span class="nc" id="L185">            String[] lines = input.split(&quot;\n&quot;);</span>
            
<span class="nc bnc" id="L187" title="All 2 branches missed.">            if (lines.length &lt; 2) {</span>
<span class="nc" id="L188">                return result; // Empty or header only</span>
            }

            // Skip header row
<span class="nc bnc" id="L192" title="All 2 branches missed.">            for (int i = 1; i &lt; lines.length; i++) {</span>
<span class="nc" id="L193">                String line = lines[i].trim();</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">                if (line.isEmpty()) continue;</span>

                try {
<span class="nc" id="L197">                    Order order = parseCsvLine(line, i + 1);</span>
                    
                    // Validate subtotal
<span class="nc" id="L200">                    String validationError = validateOrder(order);</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">                    if (validationError != null) {</span>
<span class="nc" id="L202">                        result.addError(new ParseError(&quot;csv&quot;, i + 1, validationError));</span>
                    } else {
<span class="nc" id="L204">                        result.addOrder(order);</span>
                    }
<span class="nc" id="L206">                } catch (Exception e) {</span>
<span class="nc" id="L207">                    result.addError(new ParseError(&quot;csv&quot;, i + 1, e.getMessage()));</span>
<span class="nc" id="L208">                }</span>
            }

<span class="nc" id="L211">            return result;</span>
        }

        private Order parseCsvLine(String line, int rowNum) {
            // Handle quoted fields with commas
<span class="nc" id="L216">            List&lt;String&gt; fields = parseCsvFields(line);</span>
            
<span class="nc bnc" id="L218" title="All 2 branches missed.">            if (fields.size() &lt; 9) {</span>
<span class="nc" id="L219">                throw new IllegalArgumentException(&quot;Expected 9 fields, got &quot; + fields.size());</span>
            }

<span class="nc" id="L222">            String orderId = fields.get(0);</span>
<span class="nc" id="L223">            Instant createdAt = Instant.parse(fields.get(1));</span>
<span class="nc" id="L224">            String customerId = fields.get(2);</span>
<span class="nc" id="L225">            String currency = fields.get(3);</span>
<span class="nc" id="L226">            String itemsStr = fields.get(4);</span>
<span class="nc" id="L227">            BigDecimal subtotal = new BigDecimal(fields.get(5));</span>
<span class="nc" id="L228">            BigDecimal discount = new BigDecimal(fields.get(6));</span>
<span class="nc" id="L229">            BigDecimal tax = new BigDecimal(fields.get(7));</span>
<span class="nc" id="L230">            BigDecimal shipping = new BigDecimal(fields.get(8));</span>

<span class="nc" id="L232">            List&lt;Item&gt; items = parseItemsString(itemsStr);</span>
<span class="nc" id="L233">            Charges charges = new Charges(subtotal, discount, tax, shipping);</span>

<span class="nc" id="L235">            return new Order(orderId, createdAt, customerId, currency, items, charges);</span>
        }

        private List&lt;String&gt; parseCsvFields(String line) {
<span class="nc" id="L239">            List&lt;String&gt; fields = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L240">            StringBuilder current = new StringBuilder();</span>
<span class="nc" id="L241">            boolean inQuotes = false;</span>

<span class="nc bnc" id="L243" title="All 2 branches missed.">            for (char c : line.toCharArray()) {</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">                if (c == '&quot;') {</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">                    inQuotes = !inQuotes;</span>
<span class="nc bnc" id="L246" title="All 4 branches missed.">                } else if (c == ',' &amp;&amp; !inQuotes) {</span>
<span class="nc" id="L247">                    fields.add(current.toString().trim());</span>
<span class="nc" id="L248">                    current = new StringBuilder();</span>
                } else {
<span class="nc" id="L250">                    current.append(c);</span>
                }
            }
<span class="nc" id="L253">            fields.add(current.toString().trim());</span>

<span class="nc" id="L255">            return fields;</span>
        }

        private List&lt;Item&gt; parseItemsString(String itemsStr) {
<span class="nc" id="L259">            List&lt;Item&gt; items = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L260">            String[] itemParts = itemsStr.split(&quot;\\|&quot;);</span>

<span class="nc bnc" id="L262" title="All 2 branches missed.">            for (String itemPart : itemParts) {</span>
<span class="nc" id="L263">                Map&lt;String, String&gt; props = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">                for (String prop : itemPart.split(&quot;;&quot;)) {</span>
<span class="nc" id="L265">                    String[] kv = prop.split(&quot;=&quot;);</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">                    if (kv.length == 2) {</span>
<span class="nc" id="L267">                        props.put(kv[0].trim(), kv[1].trim());</span>
                    }
                }

<span class="nc" id="L271">                String sku = props.get(&quot;sku&quot;);</span>
<span class="nc" id="L272">                int qty = Integer.parseInt(props.get(&quot;qty&quot;));</span>
<span class="nc" id="L273">                BigDecimal price = new BigDecimal(props.get(&quot;price&quot;));</span>

<span class="nc" id="L275">                items.add(new Item(sku, qty, price));</span>
            }

<span class="nc" id="L278">            return items;</span>
        }

        private String validateOrder(Order order) {
            // Check quantity &gt; 0
<span class="nc bnc" id="L283" title="All 2 branches missed.">            for (Item item : order.getItems()) {</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">                if (item.getQuantity() &lt;= 0) {</span>
<span class="nc" id="L285">                    return &quot;qty must be &gt; 0 for sku &quot; + item.getSku();</span>
                }
<span class="nc bnc" id="L287" title="All 2 branches missed.">                if (item.getUnitPrice().compareTo(BigDecimal.ZERO) &lt; 0) {</span>
<span class="nc" id="L288">                    return &quot;unit_price must be &gt;= 0 for sku &quot; + item.getSku();</span>
                }
<span class="nc" id="L290">            }</span>

            // Check subtotal matches items total (within tolerance)
<span class="nc" id="L293">            BigDecimal itemsTotal = order.getItemsTotal();</span>
<span class="nc" id="L294">            BigDecimal subtotal = order.getCharges().getSubtotal();</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">            if (itemsTotal.subtract(subtotal).abs().compareTo(TOLERANCE) &gt; 0) {</span>
<span class="nc" id="L296">                return &quot;subtotal mismatch: expected &quot; + itemsTotal + &quot;, got &quot; + subtotal;</span>
            }

            // Check currency present
<span class="nc bnc" id="L300" title="All 2 branches missed.">            if (order.getCurrency().isEmpty()) {</span>
<span class="nc" id="L301">                return &quot;currency is required&quot;;</span>
            }

<span class="nc" id="L304">            return null; // Valid</span>
        }
    }

    /**
     * JSON Order Parser.
     */
<span class="nc" id="L311">    public static class JsonOrderParser implements OrderParser {</span>
<span class="nc" id="L312">        private static final BigDecimal TOLERANCE = new BigDecimal(&quot;0.01&quot;);</span>

        @Override
        public ParseResult parse(String input) {
<span class="nc" id="L316">            ParseResult result = new ParseResult(new ArrayList&lt;&gt;(), new ArrayList&lt;&gt;());</span>
            
            try {
                // Simple JSON array parsing (no external dependencies)
<span class="nc" id="L320">                List&lt;Map&lt;String, Object&gt;&gt; jsonOrders = parseJsonArray(input);</span>
                
<span class="nc" id="L322">                int row = 1;</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">                for (Map&lt;String, Object&gt; jsonOrder : jsonOrders) {</span>
                    try {
<span class="nc" id="L325">                        Order order = parseJsonOrder(jsonOrder);</span>
                        
<span class="nc" id="L327">                        String validationError = validateOrder(order);</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">                        if (validationError != null) {</span>
<span class="nc" id="L329">                            result.addError(new ParseError(&quot;json&quot;, row, validationError));</span>
                        } else {
<span class="nc" id="L331">                            result.addOrder(order);</span>
                        }
<span class="nc" id="L333">                    } catch (Exception e) {</span>
<span class="nc" id="L334">                        result.addError(new ParseError(&quot;json&quot;, row, e.getMessage()));</span>
<span class="nc" id="L335">                    }</span>
<span class="nc" id="L336">                    row++;</span>
<span class="nc" id="L337">                }</span>
<span class="nc" id="L338">            } catch (Exception e) {</span>
<span class="nc" id="L339">                result.addError(new ParseError(&quot;json&quot;, 0, &quot;Failed to parse JSON: &quot; + e.getMessage()));</span>
<span class="nc" id="L340">            }</span>

<span class="nc" id="L342">            return result;</span>
        }

        @SuppressWarnings(&quot;unchecked&quot;)
        private Order parseJsonOrder(Map&lt;String, Object&gt; json) {
<span class="nc" id="L347">            String orderId = getString(json, &quot;id&quot;);</span>
<span class="nc" id="L348">            Instant createdAt = Instant.parse(getString(json, &quot;createdAt&quot;));</span>
            
<span class="nc" id="L350">            Map&lt;String, Object&gt; customer = (Map&lt;String, Object&gt;) json.get(&quot;customer&quot;);</span>
<span class="nc" id="L351">            String customerId = getString(customer, &quot;id&quot;);</span>
            
<span class="nc" id="L353">            String currency = getString(json, &quot;currency&quot;);</span>
            
<span class="nc" id="L355">            List&lt;Map&lt;String, Object&gt;&gt; lineItems = (List&lt;Map&lt;String, Object&gt;&gt;) json.get(&quot;lineItems&quot;);</span>
<span class="nc" id="L356">            List&lt;Item&gt; items = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">            for (Map&lt;String, Object&gt; li : lineItems) {</span>
<span class="nc" id="L358">                String sku = getString(li, &quot;sku&quot;);</span>
<span class="nc" id="L359">                int qty = getInt(li, &quot;quantity&quot;);</span>
<span class="nc" id="L360">                BigDecimal price = getBigDecimal(li, &quot;unitPrice&quot;);</span>
<span class="nc" id="L361">                items.add(new Item(sku, qty, price));</span>
<span class="nc" id="L362">            }</span>
            
<span class="nc" id="L364">            Map&lt;String, Object&gt; chargesJson = (Map&lt;String, Object&gt;) json.get(&quot;charges&quot;);</span>
<span class="nc" id="L365">            Charges charges = new Charges(</span>
<span class="nc" id="L366">                getBigDecimal(chargesJson, &quot;subtotal&quot;),</span>
<span class="nc" id="L367">                getBigDecimal(chargesJson, &quot;discount&quot;),</span>
<span class="nc" id="L368">                getBigDecimal(chargesJson, &quot;tax&quot;),</span>
<span class="nc" id="L369">                getBigDecimal(chargesJson, &quot;shipping&quot;)</span>
            );

<span class="nc" id="L372">            return new Order(orderId, createdAt, customerId, currency, items, charges);</span>
        }

        private String getString(Map&lt;String, Object&gt; map, String key) {
<span class="nc" id="L376">            Object val = map.get(key);</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">            return val != null ? val.toString() : &quot;&quot;;</span>
        }

        private int getInt(Map&lt;String, Object&gt; map, String key) {
<span class="nc" id="L381">            Object val = map.get(key);</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">            if (val instanceof Number) {</span>
<span class="nc" id="L383">                return ((Number) val).intValue();</span>
            }
<span class="nc" id="L385">            return Integer.parseInt(val.toString());</span>
        }

        private BigDecimal getBigDecimal(Map&lt;String, Object&gt; map, String key) {
<span class="nc" id="L389">            Object val = map.get(key);</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">            if (val instanceof Number) {</span>
<span class="nc" id="L391">                return BigDecimal.valueOf(((Number) val).doubleValue());</span>
            }
<span class="nc" id="L393">            return new BigDecimal(val.toString());</span>
        }

        // Simple JSON parser (for demonstration - in production use Jackson/Gson)
        @SuppressWarnings(&quot;unchecked&quot;)
        private List&lt;Map&lt;String, Object&gt;&gt; parseJsonArray(String json) {
<span class="nc" id="L399">            json = json.trim();</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">            if (!json.startsWith(&quot;[&quot;)) {</span>
<span class="nc" id="L401">                throw new IllegalArgumentException(&quot;Expected JSON array&quot;);</span>
            }
            
<span class="nc" id="L404">            List&lt;Map&lt;String, Object&gt;&gt; result = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L405">            int depth = 0;</span>
<span class="nc" id="L406">            int start = -1;</span>
            
<span class="nc bnc" id="L408" title="All 2 branches missed.">            for (int i = 0; i &lt; json.length(); i++) {</span>
<span class="nc" id="L409">                char c = json.charAt(i);</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">                if (c == '{') {</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">                    if (depth == 1) start = i;</span>
<span class="nc" id="L412">                    depth++;</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">                } else if (c == '}') {</span>
<span class="nc" id="L414">                    depth--;</span>
<span class="nc bnc" id="L415" title="All 4 branches missed.">                    if (depth == 1 &amp;&amp; start &gt;= 0) {</span>
<span class="nc" id="L416">                        String objStr = json.substring(start, i + 1);</span>
<span class="nc" id="L417">                        result.add(parseJsonObject(objStr));</span>
<span class="nc" id="L418">                        start = -1;</span>
<span class="nc" id="L419">                    }</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">                } else if (c == '[') {</span>
<span class="nc" id="L421">                    depth++;</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">                } else if (c == ']') {</span>
<span class="nc" id="L423">                    depth--;</span>
                }
            }
            
<span class="nc" id="L427">            return result;</span>
        }

        @SuppressWarnings(&quot;unchecked&quot;)
        private Map&lt;String, Object&gt; parseJsonObject(String json) {
<span class="nc" id="L432">            Map&lt;String, Object&gt; map = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L433">            json = json.trim();</span>
<span class="nc bnc" id="L434" title="All 4 branches missed.">            if (!json.startsWith(&quot;{&quot;) || !json.endsWith(&quot;}&quot;)) {</span>
<span class="nc" id="L435">                throw new IllegalArgumentException(&quot;Invalid JSON object&quot;);</span>
            }
            
<span class="nc" id="L438">            json = json.substring(1, json.length() - 1).trim();</span>
            
<span class="nc" id="L440">            int i = 0;</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">            while (i &lt; json.length()) {</span>
                // Skip whitespace
<span class="nc bnc" id="L443" title="All 4 branches missed.">                while (i &lt; json.length() &amp;&amp; Character.isWhitespace(json.charAt(i))) i++;</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">                if (i &gt;= json.length()) break;</span>
                
                // Parse key
<span class="nc bnc" id="L447" title="All 2 branches missed.">                if (json.charAt(i) != '&quot;') {</span>
<span class="nc" id="L448">                    i++;</span>
<span class="nc" id="L449">                    continue;</span>
                }
<span class="nc" id="L451">                i++;</span>
<span class="nc" id="L452">                int keyStart = i;</span>
<span class="nc bnc" id="L453" title="All 4 branches missed.">                while (i &lt; json.length() &amp;&amp; json.charAt(i) != '&quot;') i++;</span>
<span class="nc" id="L454">                String key = json.substring(keyStart, i);</span>
<span class="nc" id="L455">                i++; // skip closing quote</span>
                
                // Skip colon
<span class="nc bnc" id="L458" title="All 4 branches missed.">                while (i &lt; json.length() &amp;&amp; json.charAt(i) != ':') i++;</span>
<span class="nc" id="L459">                i++;</span>
                
                // Skip whitespace
<span class="nc bnc" id="L462" title="All 4 branches missed.">                while (i &lt; json.length() &amp;&amp; Character.isWhitespace(json.charAt(i))) i++;</span>
                
                // Parse value
                Object value;
<span class="nc bnc" id="L466" title="All 2 branches missed.">                if (json.charAt(i) == '&quot;') {</span>
<span class="nc" id="L467">                    i++;</span>
<span class="nc" id="L468">                    int valStart = i;</span>
<span class="nc bnc" id="L469" title="All 4 branches missed.">                    while (i &lt; json.length() &amp;&amp; json.charAt(i) != '&quot;') i++;</span>
<span class="nc" id="L470">                    value = json.substring(valStart, i);</span>
<span class="nc" id="L471">                    i++;</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">                } else if (json.charAt(i) == '{') {</span>
<span class="nc" id="L473">                    int depth = 1;</span>
<span class="nc" id="L474">                    int objStart = i;</span>
<span class="nc" id="L475">                    i++;</span>
<span class="nc bnc" id="L476" title="All 4 branches missed.">                    while (i &lt; json.length() &amp;&amp; depth &gt; 0) {</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">                        if (json.charAt(i) == '{') depth++;</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">                        else if (json.charAt(i) == '}') depth--;</span>
<span class="nc" id="L479">                        i++;</span>
                    }
<span class="nc" id="L481">                    value = parseJsonObject(json.substring(objStart, i));</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">                } else if (json.charAt(i) == '[') {</span>
<span class="nc" id="L483">                    int depth = 1;</span>
<span class="nc" id="L484">                    int arrStart = i;</span>
<span class="nc" id="L485">                    i++;</span>
<span class="nc bnc" id="L486" title="All 4 branches missed.">                    while (i &lt; json.length() &amp;&amp; depth &gt; 0) {</span>
<span class="nc bnc" id="L487" title="All 4 branches missed.">                        if (json.charAt(i) == '[' || json.charAt(i) == '{') depth++;</span>
<span class="nc bnc" id="L488" title="All 4 branches missed.">                        else if (json.charAt(i) == ']' || json.charAt(i) == '}') depth--;</span>
<span class="nc" id="L489">                        i++;</span>
                    }
<span class="nc" id="L491">                    String arrStr = json.substring(arrStart, i);</span>
<span class="nc" id="L492">                    value = parseJsonArrayOfObjects(arrStr);</span>
<span class="nc" id="L493">                } else {</span>
<span class="nc" id="L494">                    int valStart = i;</span>
<span class="nc bnc" id="L495" title="All 6 branches missed.">                    while (i &lt; json.length() &amp;&amp; json.charAt(i) != ',' &amp;&amp; json.charAt(i) != '}') i++;</span>
<span class="nc" id="L496">                    String valStr = json.substring(valStart, i).trim();</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">                    if (valStr.contains(&quot;.&quot;)) {</span>
<span class="nc" id="L498">                        value = Double.parseDouble(valStr);</span>
                    } else {
                        try {
<span class="nc" id="L501">                            value = Long.parseLong(valStr);</span>
<span class="nc" id="L502">                        } catch (NumberFormatException e) {</span>
<span class="nc" id="L503">                            value = valStr;</span>
<span class="nc" id="L504">                        }</span>
                    }
                }
                
<span class="nc" id="L508">                map.put(key, value);</span>
                
                // Skip comma
<span class="nc bnc" id="L511" title="All 6 branches missed.">                while (i &lt; json.length() &amp;&amp; (json.charAt(i) == ',' || Character.isWhitespace(json.charAt(i)))) i++;</span>
<span class="nc" id="L512">            }</span>
            
<span class="nc" id="L514">            return map;</span>
        }

        private List&lt;Map&lt;String, Object&gt;&gt; parseJsonArrayOfObjects(String json) {
<span class="nc" id="L518">            List&lt;Map&lt;String, Object&gt;&gt; result = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L519">            json = json.trim();</span>
<span class="nc bnc" id="L520" title="All 4 branches missed.">            if (!json.startsWith(&quot;[&quot;) || !json.endsWith(&quot;]&quot;)) {</span>
<span class="nc" id="L521">                return result;</span>
            }
            
<span class="nc" id="L524">            json = json.substring(1, json.length() - 1).trim();</span>
<span class="nc" id="L525">            int i = 0;</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">            while (i &lt; json.length()) {</span>
<span class="nc bnc" id="L527" title="All 4 branches missed.">                while (i &lt; json.length() &amp;&amp; json.charAt(i) != '{') i++;</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">                if (i &gt;= json.length()) break;</span>
                
<span class="nc" id="L530">                int depth = 1;</span>
<span class="nc" id="L531">                int objStart = i;</span>
<span class="nc" id="L532">                i++;</span>
<span class="nc bnc" id="L533" title="All 4 branches missed.">                while (i &lt; json.length() &amp;&amp; depth &gt; 0) {</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">                    if (json.charAt(i) == '{') depth++;</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">                    else if (json.charAt(i) == '}') depth--;</span>
<span class="nc" id="L536">                    i++;</span>
                }
<span class="nc" id="L538">                result.add(parseJsonObject(json.substring(objStart, i)));</span>
<span class="nc" id="L539">            }</span>
            
<span class="nc" id="L541">            return result;</span>
        }

        private String validateOrder(Order order) {
<span class="nc bnc" id="L545" title="All 2 branches missed.">            for (Item item : order.getItems()) {</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">                if (item.getQuantity() &lt;= 0) {</span>
<span class="nc" id="L547">                    return &quot;qty must be &gt; 0 for sku &quot; + item.getSku();</span>
                }
<span class="nc bnc" id="L549" title="All 2 branches missed.">                if (item.getUnitPrice().compareTo(BigDecimal.ZERO) &lt; 0) {</span>
<span class="nc" id="L550">                    return &quot;unit_price must be &gt;= 0 for sku &quot; + item.getSku();</span>
                }
<span class="nc" id="L552">            }</span>

<span class="nc" id="L554">            BigDecimal itemsTotal = order.getItemsTotal();</span>
<span class="nc" id="L555">            BigDecimal subtotal = order.getCharges().getSubtotal();</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">            if (itemsTotal.subtract(subtotal).abs().compareTo(TOLERANCE) &gt; 0) {</span>
<span class="nc" id="L557">                return &quot;subtotal mismatch: expected &quot; + itemsTotal + &quot;, got &quot; + subtotal;</span>
            }

<span class="nc bnc" id="L560" title="All 2 branches missed.">            if (order.getCurrency().isEmpty()) {</span>
<span class="nc" id="L561">                return &quot;currency is required&quot;;</span>
            }

<span class="nc" id="L564">            return null;</span>
        }
    }

    // ==================== AGGREGATION ====================

    /**
     * Product statistics for aggregation.
     */
    public static class ProductStats {
        private final String sku;
        private BigDecimal grossSales;
        private int unitsSold;

<span class="nc" id="L578">        public ProductStats(String sku) {</span>
<span class="nc" id="L579">            this.sku = sku;</span>
<span class="nc" id="L580">            this.grossSales = BigDecimal.ZERO;</span>
<span class="nc" id="L581">            this.unitsSold = 0;</span>
<span class="nc" id="L582">        }</span>

        public void add(int quantity, BigDecimal lineTotal) {
<span class="nc" id="L585">            this.unitsSold += quantity;</span>
<span class="nc" id="L586">            this.grossSales = this.grossSales.add(lineTotal);</span>
<span class="nc" id="L587">        }</span>

<span class="nc" id="L589">        public String getSku() { return sku; }</span>
<span class="nc" id="L590">        public BigDecimal getGrossSales() { return grossSales; }</span>
<span class="nc" id="L591">        public int getUnitsSold() { return unitsSold; }</span>
    }

    /**
     * Aggregation report.
     */
    public static class Report {
        private final Map&lt;String, BigDecimal&gt; revenueByCountry;
        private final List&lt;ProductStats&gt; topProducts;
        private final int returningCustomers;
        private final Map&lt;String, Integer&gt; ordersByDate;
        private final List&lt;ParseError&gt; errors;

        public Report(Map&lt;String, BigDecimal&gt; revenueByCountry,
                      List&lt;ProductStats&gt; topProducts,
                      int returningCustomers,
                      Map&lt;String, Integer&gt; ordersByDate,
<span class="nc" id="L608">                      List&lt;ParseError&gt; errors) {</span>
<span class="nc" id="L609">            this.revenueByCountry = revenueByCountry;</span>
<span class="nc" id="L610">            this.topProducts = topProducts;</span>
<span class="nc" id="L611">            this.returningCustomers = returningCustomers;</span>
<span class="nc" id="L612">            this.ordersByDate = ordersByDate;</span>
<span class="nc" id="L613">            this.errors = errors;</span>
<span class="nc" id="L614">        }</span>

<span class="nc" id="L616">        public Map&lt;String, BigDecimal&gt; getRevenueByCountry() { return revenueByCountry; }</span>
<span class="nc" id="L617">        public List&lt;ProductStats&gt; getTopProducts() { return topProducts; }</span>
<span class="nc" id="L618">        public int getReturningCustomers() { return returningCustomers; }</span>
<span class="nc" id="L619">        public Map&lt;String, Integer&gt; getOrdersByDate() { return ordersByDate; }</span>
<span class="nc" id="L620">        public List&lt;ParseError&gt; getErrors() { return errors; }</span>
    }

    /**
     * Order Aggregator - computes metrics from orders.
     */
<span class="nc" id="L626">    public static class OrderAggregator {</span>

        public Report aggregate(List&lt;Order&gt; orders, List&lt;ParseError&gt; errors, int topN) {
<span class="nc" id="L629">            Map&lt;String, BigDecimal&gt; revenueByCountry = computeRevenueByCountry(orders);</span>
<span class="nc" id="L630">            List&lt;ProductStats&gt; topProducts = computeTopProducts(orders, topN);</span>
<span class="nc" id="L631">            int returningCustomers = computeReturningCustomers(orders);</span>
<span class="nc" id="L632">            Map&lt;String, Integer&gt; ordersByDate = computeOrdersByDate(orders);</span>

<span class="nc" id="L634">            return new Report(revenueByCountry, topProducts, returningCustomers, ordersByDate, errors);</span>
        }

        private Map&lt;String, BigDecimal&gt; computeRevenueByCountry(List&lt;Order&gt; orders) {
<span class="nc" id="L638">            Map&lt;String, BigDecimal&gt; result = new TreeMap&lt;&gt;();</span>
            
<span class="nc bnc" id="L640" title="All 2 branches missed.">            for (Order order : orders) {</span>
<span class="nc" id="L641">                String currency = order.getCurrency();</span>
<span class="nc" id="L642">                BigDecimal total = order.getTotal();</span>
<span class="nc" id="L643">                result.merge(currency, total, BigDecimal::add);</span>
<span class="nc" id="L644">            }</span>
            
<span class="nc" id="L646">            return result;</span>
        }

        private List&lt;ProductStats&gt; computeTopProducts(List&lt;Order&gt; orders, int topN) {
<span class="nc" id="L650">            Map&lt;String, ProductStats&gt; statsMap = new HashMap&lt;&gt;();</span>
            
<span class="nc bnc" id="L652" title="All 2 branches missed.">            for (Order order : orders) {</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">                for (Item item : order.getItems()) {</span>
<span class="nc" id="L654">                    ProductStats stats = statsMap.computeIfAbsent(</span>
<span class="nc" id="L655">                        item.getSku(), ProductStats::new);</span>
<span class="nc" id="L656">                    stats.add(item.getQuantity(), item.getLineTotal());</span>
<span class="nc" id="L657">                }</span>
<span class="nc" id="L658">            }</span>
            
<span class="nc" id="L660">            return statsMap.values().stream()</span>
<span class="nc" id="L661">                    .sorted((a, b) -&gt; {</span>
<span class="nc" id="L662">                        int cmp = b.getGrossSales().compareTo(a.getGrossSales());</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">                        return cmp != 0 ? cmp : a.getSku().compareTo(b.getSku());</span>
                    })
<span class="nc" id="L665">                    .limit(topN)</span>
<span class="nc" id="L666">                    .collect(Collectors.toList());</span>
        }

        private int computeReturningCustomers(List&lt;Order&gt; orders) {
<span class="nc" id="L670">            Map&lt;String, Integer&gt; customerOrderCount = new HashMap&lt;&gt;();</span>
            
<span class="nc bnc" id="L672" title="All 2 branches missed.">            for (Order order : orders) {</span>
<span class="nc" id="L673">                customerOrderCount.merge(order.getCustomerId(), 1, Integer::sum);</span>
<span class="nc" id="L674">            }</span>
            
<span class="nc" id="L676">            return (int) customerOrderCount.values().stream()</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">                    .filter(count -&gt; count &gt;= 2)</span>
<span class="nc" id="L678">                    .count();</span>
        }

        private Map&lt;String, Integer&gt; computeOrdersByDate(List&lt;Order&gt; orders) {
<span class="nc" id="L682">            Map&lt;String, Integer&gt; result = new TreeMap&lt;&gt;();</span>
            
<span class="nc bnc" id="L684" title="All 2 branches missed.">            for (Order order : orders) {</span>
<span class="nc" id="L685">                String date = order.getOrderDate().toString();</span>
<span class="nc" id="L686">                result.merge(date, 1, Integer::sum);</span>
<span class="nc" id="L687">            }</span>
            
<span class="nc" id="L689">            return result;</span>
        }
    }

    // ==================== OUTPUT ====================

    /**
     * JSON Report Writer.
     */
<span class="nc" id="L698">    public static class JsonReportWriter {</span>

        public String write(Report report) {
<span class="nc" id="L701">            StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L702">            sb.append(&quot;{\n&quot;);</span>
            
            // Revenue by currency
<span class="nc" id="L705">            sb.append(&quot;  \&quot;total_revenue_by_currency\&quot;: {&quot;);</span>
<span class="nc" id="L706">            boolean first = true;</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">            for (Map.Entry&lt;String, BigDecimal&gt; entry : report.getRevenueByCountry().entrySet()) {</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">                if (!first) sb.append(&quot;,&quot;);</span>
<span class="nc" id="L709">                sb.append(&quot;\n    \&quot;&quot;).append(entry.getKey()).append(&quot;\&quot;: \&quot;&quot;)</span>
<span class="nc" id="L710">                  .append(entry.getValue().setScale(2, RoundingMode.HALF_UP)).append(&quot;\&quot;&quot;);</span>
<span class="nc" id="L711">                first = false;</span>
<span class="nc" id="L712">            }</span>
<span class="nc" id="L713">            sb.append(&quot;\n  },\n&quot;);</span>
            
            // Top products
<span class="nc" id="L716">            sb.append(&quot;  \&quot;top_products\&quot;: [&quot;);</span>
<span class="nc" id="L717">            first = true;</span>
<span class="nc bnc" id="L718" title="All 2 branches missed.">            for (ProductStats ps : report.getTopProducts()) {</span>
<span class="nc bnc" id="L719" title="All 2 branches missed.">                if (!first) sb.append(&quot;,&quot;);</span>
<span class="nc" id="L720">                sb.append(&quot;\n    {\&quot;sku\&quot;: \&quot;&quot;).append(ps.getSku())</span>
<span class="nc" id="L721">                  .append(&quot;\&quot;, \&quot;gross_sales\&quot;: \&quot;&quot;)</span>
<span class="nc" id="L722">                  .append(ps.getGrossSales().setScale(2, RoundingMode.HALF_UP))</span>
<span class="nc" id="L723">                  .append(&quot;\&quot;, \&quot;units_sold\&quot;: &quot;).append(ps.getUnitsSold()).append(&quot;}&quot;);</span>
<span class="nc" id="L724">                first = false;</span>
<span class="nc" id="L725">            }</span>
<span class="nc" id="L726">            sb.append(&quot;\n  ],\n&quot;);</span>
            
            // Returning customers
<span class="nc" id="L729">            sb.append(&quot;  \&quot;returning_customers\&quot;: &quot;).append(report.getReturningCustomers()).append(&quot;,\n&quot;);</span>
            
            // Orders by date
<span class="nc" id="L732">            sb.append(&quot;  \&quot;orders_by_date\&quot;: {&quot;);</span>
<span class="nc" id="L733">            first = true;</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">            for (Map.Entry&lt;String, Integer&gt; entry : report.getOrdersByDate().entrySet()) {</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">                if (!first) sb.append(&quot;,&quot;);</span>
<span class="nc" id="L736">                sb.append(&quot;\n    \&quot;&quot;).append(entry.getKey()).append(&quot;\&quot;: &quot;)</span>
<span class="nc" id="L737">                  .append(entry.getValue());</span>
<span class="nc" id="L738">                first = false;</span>
<span class="nc" id="L739">            }</span>
<span class="nc" id="L740">            sb.append(&quot;\n  },\n&quot;);</span>
            
            // Errors
<span class="nc" id="L743">            sb.append(&quot;  \&quot;errors\&quot;: [&quot;);</span>
<span class="nc" id="L744">            first = true;</span>
<span class="nc bnc" id="L745" title="All 2 branches missed.">            for (ParseError error : report.getErrors()) {</span>
<span class="nc bnc" id="L746" title="All 2 branches missed.">                if (!first) sb.append(&quot;,&quot;);</span>
<span class="nc" id="L747">                sb.append(&quot;\n    &quot;).append(error.toString());</span>
<span class="nc" id="L748">                first = false;</span>
<span class="nc" id="L749">            }</span>
<span class="nc" id="L750">            sb.append(&quot;\n  ]\n&quot;);</span>
            
<span class="nc" id="L752">            sb.append(&quot;}&quot;);</span>
<span class="nc" id="L753">            return sb.toString();</span>
        }
    }

    // ==================== MAIN ORCHESTRATOR ====================

<span class="nc" id="L759">    private final CsvOrderParser csvParser = new CsvOrderParser();</span>
<span class="nc" id="L760">    private final JsonOrderParser jsonParser = new JsonOrderParser();</span>
<span class="nc" id="L761">    private final OrderAggregator aggregator = new OrderAggregator();</span>
<span class="nc" id="L762">    private final JsonReportWriter reportWriter = new JsonReportWriter();</span>

    /**
     * Process CSV input and generate report.
     */
    public String processCsv(String csvInput, int topN) {
<span class="nc" id="L768">        ParseResult result = csvParser.parse(csvInput);</span>
<span class="nc" id="L769">        Report report = aggregator.aggregate(result.getOrders(), result.getErrors(), topN);</span>
<span class="nc" id="L770">        return reportWriter.write(report);</span>
    }

    /**
     * Process JSON input and generate report.
     */
    public String processJson(String jsonInput, int topN) {
<span class="nc" id="L777">        ParseResult result = jsonParser.parse(jsonInput);</span>
<span class="nc" id="L778">        Report report = aggregator.aggregate(result.getOrders(), result.getErrors(), topN);</span>
<span class="nc" id="L779">        return reportWriter.write(report);</span>
    }

    /**
     * Process both CSV and JSON inputs and generate combined report.
     */
    public String processAll(String csvInput, String jsonInput, int topN) {
<span class="nc" id="L786">        ParseResult csvResult = csvParser.parse(csvInput);</span>
<span class="nc" id="L787">        ParseResult jsonResult = jsonParser.parse(jsonInput);</span>
<span class="nc" id="L788">        csvResult.merge(jsonResult);</span>
        
<span class="nc" id="L790">        Report report = aggregator.aggregate(csvResult.getOrders(), csvResult.getErrors(), topN);</span>
<span class="nc" id="L791">        return reportWriter.write(report);</span>
    }

    // ==================== DEMO ====================

    public static void main(String[] args) {
<span class="nc" id="L797">        DataTransformer transformer = new DataTransformer();</span>

        // Sample CSV input
<span class="nc" id="L800">        String csvInput = &quot;&quot;&quot;</span>
            order_id,created_at,customer_id,currency,items,subtotal,discount,tax,shipping
            1001,2026-01-12T10:03:22Z,C001,USD,&quot;sku=A12;qty=2;price=19.99|sku=B55;qty=1;price=5.00&quot;,44.98,5.00,3.60,4.99
            1002,2026-01-12T11:15:00Z,C002,USD,&quot;sku=A12;qty=1;price=19.99&quot;,19.99,0.00,1.60,0.00
            &quot;&quot;&quot;;

        // Sample JSON input
<span class="nc" id="L807">        String jsonInput = &quot;&quot;&quot;</span>
            [
              {
                &quot;id&quot;: &quot;1003&quot;,
                &quot;createdAt&quot;: &quot;2026-01-12T12:05:00Z&quot;,
                &quot;customer&quot;: { &quot;id&quot;: &quot;C001&quot; },
                &quot;currency&quot;: &quot;USD&quot;,
                &quot;lineItems&quot;: [
                  { &quot;sku&quot;: &quot;B55&quot;, &quot;quantity&quot;: 3, &quot;unitPrice&quot;: 5.0 }
                ],
                &quot;charges&quot;: { &quot;subtotal&quot;: 15.0, &quot;discount&quot;: 0, &quot;tax&quot;: 1.2, &quot;shipping&quot;: 4.99 }
              }
            ]
            &quot;&quot;&quot;;

<span class="nc" id="L822">        System.out.println(&quot;=== Processing CSV Only ===&quot;);</span>
<span class="nc" id="L823">        System.out.println(transformer.processCsv(csvInput, 10));</span>

<span class="nc" id="L825">        System.out.println(&quot;\n=== Processing JSON Only ===&quot;);</span>
<span class="nc" id="L826">        System.out.println(transformer.processJson(jsonInput, 10));</span>

<span class="nc" id="L828">        System.out.println(&quot;\n=== Processing Combined ===&quot;);</span>
<span class="nc" id="L829">        System.out.println(transformer.processAll(csvInput, jsonInput, 10));</span>
<span class="nc" id="L830">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>